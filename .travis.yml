language: java
sudo: false

cache:
  apt: true
  directories:
    - ~/.m2

branches:
  only:
    - master
    - /v\d+\.\d+[a-z]/

addons:
  apt:
    packages:
      - xmlstarlet

install:
  - ""

# JDKs used in builds must be supported by Tycho.
# Check https://wiki.eclipse.org/Tycho/Release_Notes to find supported versions.
matrix:
  fast_finish: true
  include:

    # JDK 11 (Long Term Support version)
    - jdk: openjdk11
      env:
        - DESC="install (openjdk11)"
        - CMD="mvn install && git diff"

script:
  - |
    set -e
    MVN_SETTINGS=${TRAVIS_HOME}/.m2/settings.xml
    if [[ -f ${MVN_SETTINGS} ]]; then
      if [[ $TRAVIS_OS_NAME == 'osx' ]]; then
        sed -i'' -e "/<mirrors>/,/<\/mirrors>/ d" $MVN_SETTINGS
      else
        xmlstarlet ed --inplace -d "//mirrors" $MVN_SETTINGS
      fi
    fi
    echo "eval of CMD is starting";
    echo "CMD=$CMD";
    eval $CMD;
    echo "eval of CMD is completed";

before_deploy:
  - export RELEASE_PKG_FILE=$(ls gr.alexc.idelearn.updatesite/target/*.zip)
  - echo "deploying $RELEASE_PKG_FILE to GitHub releases"

deploy:
  provider: releases
  api_key: "${GH_TOKEN}"
  file_glob: true
  file: ${RELEASE_PKG_FILE}
  skip_cleanup: true
  draft: true
  on:
    branch: master
    tag: true